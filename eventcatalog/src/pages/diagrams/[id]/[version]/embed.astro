---
import { render } from 'astro:content';
import components from '@components/MDX/components';
import config from '@config';

import { Page } from './_index.data';

export const prerender = Page.prerender;
export const getStaticPaths = Page.getStaticPaths;

const props = await Page.getData(Astro);
const { Content } = await render(props);

const currentVersion = props.data.version;
const diagramId = props.data.id;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>v{currentVersion}</title>
    <style is:global>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --ec-page-bg: 255 255 255;
        --ec-page-text: 15 23 42;
        --ec-page-text-muted: 100 116 139;
        --ec-page-border: 226 232 240;
        --ec-content-hover: 241 245 249;
      }

      :root[data-theme='dark'] {
        --ec-page-bg: 13 17 23;
        --ec-page-text: 240 246 252;
        --ec-page-text-muted: 139 148 158;
        --ec-page-border: 33 38 45;
        --ec-content-hover: 33 38 45;
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          Roboto,
          sans-serif;
        background: rgb(var(--ec-page-bg));
        color: rgb(var(--ec-page-text));
      }

      .embed-container {
        padding: 1.5rem;
        height: 100vh;
        overflow: auto;
      }

      .mermaid svg {
        margin: 0 auto;
        display: block;
      }

      /* Prose styles */
      .prose {
        max-width: none;
        color: rgb(var(--ec-page-text));
      }
      .prose h1,
      .prose h2,
      .prose h3,
      .prose h4 {
        color: rgb(var(--ec-page-text));
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
      }
      .prose h1 {
        font-size: 1.875rem;
      }
      .prose h2 {
        font-size: 1.5rem;
      }
      .prose h3 {
        font-size: 1.25rem;
      }
      .prose p {
        color: rgb(var(--ec-page-text));
        margin-bottom: 1rem;
        line-height: 1.6;
      }
      .prose strong {
        color: rgb(var(--ec-page-text));
        font-weight: 600;
      }
      .prose a {
        color: rgb(var(--ec-page-text));
        text-decoration: underline;
      }
      .prose ul,
      .prose ol {
        color: rgb(var(--ec-page-text));
        margin-bottom: 1rem;
        padding-left: 1.5rem;
      }
      .prose li {
        margin-bottom: 0.25rem;
      }
      .prose code {
        color: rgb(var(--ec-page-text));
        background: rgb(var(--ec-page-border));
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
      }
      .prose pre {
        background: rgb(var(--ec-page-border));
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 1rem;
      }
      .prose pre code {
        background: transparent;
        padding: 0;
      }
      .prose img {
        max-width: 100%;
        height: auto;
      }
      .prose blockquote {
        border-left: 4px solid rgb(var(--ec-page-border));
        padding-left: 1rem;
        color: rgb(var(--ec-page-text-muted));
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <script is:inline>
      // Inherit theme from parent window
      try {
        const parentTheme = window.parent?.document?.documentElement?.getAttribute('data-theme');
        if (parentTheme) {
          document.documentElement.setAttribute('data-theme', parentTheme);
        }
      } catch (e) {
        // Cross-origin, ignore
      }
    </script>

    <div class="embed-container">
      <div class="flex items-center justify-between mb-4 pb-3 border-b border-[rgb(var(--ec-page-border))]">
        <span class="text-sm font-semibold text-[rgb(var(--ec-page-text))]">v{currentVersion}</span>
        <a
          id="go-to-diagram"
          href="#"
          target="_top"
          class="text-xs font-medium text-[rgb(var(--ec-page-text-muted))] border border-[rgb(var(--ec-page-border))] rounded-md px-3 py-1 hover:bg-[rgb(var(--ec-content-hover))] hover:text-[rgb(var(--ec-page-text))] transition-colors"
        >
          Go to diagram
        </a>
      </div>
      <article class="prose">
        <Content components={components(props)} />
      </article>
    </div>

    <script is:inline define:vars={{ config, baseUrl: import.meta.env.BASE_URL }}>
      window.eventcatalog = { mermaid: config?.mermaid };

      // Set the go-to-diagram link by parsing URL: /diagrams/{id}/{version}/embed
      const goToBtn = document.getElementById('go-to-diagram');
      if (goToBtn) {
        const pathParts = window.location.pathname.split('/');
        const diagramsIndex = pathParts.indexOf('diagrams');
        const diagramId = diagramsIndex !== -1 ? pathParts[diagramsIndex + 1] : '';
        const version = diagramsIndex !== -1 ? pathParts[diagramsIndex + 2] : '';
        const base = baseUrl === '/' ? '' : baseUrl;
        goToBtn.href = `${base}/diagrams/${diagramId}/${version}`;
      }

      async function renderMermaid() {
        const graphs = document.getElementsByClassName('mermaid');
        if (graphs.length === 0) return;

        const { default: mermaid } = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');
        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';

        mermaid.initialize({
          startOnLoad: false,
          theme: isDarkMode ? 'dark' : 'default',
          fontFamily: 'system-ui, -apple-system, sans-serif',
        });

        for (const graph of graphs) {
          const content = graph.getAttribute('data-content');
          if (!content) continue;
          const id = 'mermaid-' + Math.round(Math.random() * 100000);
          try {
            const result = await mermaid.render(id, content);
            graph.innerHTML = result.svg;
          } catch (e) {
            console.error('Mermaid render error:', e);
          }
        }
      }

      renderMermaid();

      // PlantUML rendering
      async function renderPlantUML() {
        const blocks = document.getElementsByClassName('plantuml');
        if (blocks.length === 0) return;

        const { deflate } = await import('https://cdn.jsdelivr.net/npm/pako@2.1.0/+esm');

        function encode64(data) {
          const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_';
          let str = '';
          const len = data.length;
          for (let i = 0; i < len; i += 3) {
            const b1 = data[i];
            const b2 = i + 1 < len ? data[i + 1] : 0;
            const b3 = i + 2 < len ? data[i + 2] : 0;

            let c1 = b1 >> 2;
            let c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
            let c3 = ((b2 & 0xf) << 2) | (b3 >> 6);
            let c4 = b3 & 0x3f;

            str += chars[c1] + chars[c2] + chars[c3] + chars[c4];
          }
          return str;
        }

        function encodePlantUML(text) {
          const data = new TextEncoder().encode(text);
          const compressed = deflate(data, { level: 9, to: 'Uint8Array' });
          return encode64(compressed);
        }

        for (const block of blocks) {
          const content = block.getAttribute('data-content');
          if (!content) continue;

          const encoded = encodePlantUML(content);
          const img = document.createElement('img');
          img.src = `https://www.plantuml.com/plantuml/svg/~1${encoded}`;
          img.alt = 'PlantUML diagram';
          img.loading = 'lazy';
          img.style.margin = '0 auto';
          img.style.display = 'block';
          block.innerHTML = '';
          block.appendChild(img);
        }
      }

      renderPlantUML();
    </script>
  </body>
</html>
