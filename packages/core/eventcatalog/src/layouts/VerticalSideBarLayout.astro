---
interface Props {
  title: string;
  sidebar?: boolean;
  description?: string;
  showNestedSideBar?: boolean;
}

import {
  TableProperties,
  BotMessageSquare,
  Users,
  BookOpen,
  Sparkles,
  Rocket,
  FileText,
  SquareDashedMousePointerIcon,
  Braces,
} from 'lucide-react';
import Header from '../components/Header.astro';
import SEO from '../components/Seo.astro';
import SideNav from '../components/SideNav/SideNav.astro';
import SearchDataLoader from '../components/Search/SearchDataLoader.astro';
import config from '@config';
import { getCollection } from 'astro:content';
import '@fontsource/inter';
import '@fontsource/inter/400.css'; // Specify weight
import '@fontsource/inter/700.css'; // Specify weight

// Theme CSS variables (must load before user styles)
import '../styles/theme.css';

// Theme files - imported so they're available, applied via data-catalog-theme attribute
import '../styles/themes/ocean.css';
import '../styles/themes/sapphire.css';
import '../styles/themes/sunset.css';
import '../styles/themes/forest.css';

// Get configured theme (default, ocean, etc.)
const catalogTheme = config.theme || 'default';

import { ClientRouter } from 'astro:transitions';

import { getCommands } from '@utils/collections/commands';
import { getDomains } from '@utils/collections/domains';
import { getEvents } from '@utils/collections/events';
import { getServices } from '@utils/collections/services';
import { getFlows } from '@utils/collections/flows';
import { isCollectionVisibleInCatalog } from '@eventcatalog';
import { buildUrl } from '@utils/url-builder';
import { getQueries } from '@utils/collections/queries';
import { hasLandingPageForDocs } from '@utils/pages';

import { isEventCatalogUpgradeEnabled, isEmbedEnabled, isCustomStylesEnabled } from '@utils/feature';
import { getUsers } from '@utils/collections/users';
import { getTeams } from '@utils/collections/teams';

const catalogHasDefaultLandingPageForDocs = await hasLandingPageForDocs();
const customDocs = await getCollection('customPages');

// Get users and teams for directory navigation
const users = await getUsers();
const teams = await getTeams();
const directoryDefaultUrl = users.length > 0 ? '/directory/users' : teams.length > 0 ? '/directory/teams' : '/directory/users';

let events: any[] = [];
let commands: any[] = [];
let queries: any[] = [];
let services: any[] = [];
let domains: any[] = [];
let flows: any[] = [];

if (!catalogHasDefaultLandingPageForDocs) {
  [events, commands, queries, services, domains, flows] = await Promise.all([
    getEvents({ getAllVersions: false, hydrateServices: false }),
    getCommands({ getAllVersions: false, hydrateServices: false }),
    getQueries({ getAllVersions: false, hydrateServices: false }),
    getServices({ getAllVersions: false }),
    getDomains({ getAllVersions: false }),
    getFlows({ getAllVersions: false }),
  ]);
}

// Try and load any custom styles if they exist
if (isCustomStylesEnabled()) {
  try {
    await import('../../eventcatalog.styles.css');
  } catch (error) {}
}

const currentPath = Astro.url.pathname;

const getDefaultUrl = (route: string, defaultValue: string) => {
  if (route === 'docs/custom') {
    return customDocs.length > 0 ? buildUrl(`/${route}/${customDocs[0].id.replace('docs', '')}`) : buildUrl(defaultValue);
  }

  const collections = [
    { data: domains, key: 'domains' },
    { data: services, key: 'services' },
    { data: events, key: 'events' },
    { data: commands, key: 'commands' },
    { data: queries, key: 'queries' },
    { data: flows, key: 'flows' },
  ];

  for (const { data, key } of collections) {
    if (data.length > 0 && isCollectionVisibleInCatalog(key)) {
      // find the first item that has visualiser set to true
      const item = data.find((item) => item.data.visualiser !== false);
      if (item) {
        return buildUrl(`/${route}/${key}/${item.data.id}/${item.data.latestVersion}`);
      } else {
        continue;
      }
    }
  }

  return buildUrl(defaultValue);
};

const userSideBarConfiguration = config.sidebar || [];

const navigationItems = [
  {
    id: '/',
    label: 'Documentation',
    icon: BookOpen,
    href: buildUrl(config.landingPage || '/'),
    current:
      currentPath === '/' ||
      (currentPath.includes('/docs') && !currentPath.includes('/docs/custom')) ||
      currentPath.includes('/architecture/') ||
      currentPath.includes('/visualiser') ||
      (currentPath.includes('/schemas') && !currentPath.includes('/schemas/explorer')),
  },
  {
    id: '/discover',
    label: 'Explore',
    icon: TableProperties,
    href: buildUrl('/discover/domains'),
    current: currentPath.includes('/discover/'),
  },
  {
    id: '/schemas/explorer',
    label: 'Schema Explorer',
    icon: Braces,
    href: buildUrl('/schemas/explorer'),
    current: currentPath.includes('/schemas/explorer'),
  },
  {
    id: '/directory',
    label: 'Users & Teams',
    icon: Users,
    href: buildUrl(directoryDefaultUrl),
    current: currentPath.includes('/directory'),
  },
].filter((item) => {
  const userSideBarOption = userSideBarConfiguration.find((config: { id: string; visible: boolean }) => config.id === item.id);
  return userSideBarOption ? userSideBarOption.visible : true;
});

const studioNavigationItem = [
  {
    id: '/studio',
    label: 'EventCatalog Studio',
    icon: SquareDashedMousePointerIcon,
    href: buildUrl('/studio'),
    current: currentPath.includes('/studio'),
  },
].filter((item) => {
  const userSideBarOption = userSideBarConfiguration.find((config: { id: string; visible: boolean }) => config.id === item.id);
  return userSideBarOption ? userSideBarOption.visible : true;
});

const premiumFeatures = [
  {
    id: '/docs/custom',
    label: 'Custom Documentation',
    icon: FileText,
    href: getDefaultUrl('docs/custom', '/docs/custom'),
    current: currentPath.includes('/docs/custom'),
    isPremium: true,
  },
].filter((item) => {
  const userSideBarOption = userSideBarConfiguration.find((config: { id: string; visible: boolean }) => config.id === item.id);
  return userSideBarOption ? userSideBarOption.visible : true;
});

const currentNavigationItem = [...navigationItems, ...studioNavigationItem, ...premiumFeatures].find((item) => item.current);
const { title, description, showNestedSideBar = true } = Astro.props;

const canPageBeEmbedded = isEmbedEnabled();
---

<!doctype html>
<html lang="en" data-catalog-theme={catalogTheme}>
  <head>
    <!-- Inline script to prevent flash of wrong theme -->
    <script is:inline define:vars={{ catalogTheme }}>
      (function () {
        function getSystemTheme() {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
          }
          return 'light';
        }

        function applyTheme() {
          // Check localStorage first, fall back to system preference
          const stored = localStorage.getItem('eventcatalog-theme');
          const theme = stored === 'light' || stored === 'dark' ? stored : getSystemTheme();
          document.documentElement.setAttribute('data-theme', theme);
          // Also ensure catalog theme is set (for page transitions)
          document.documentElement.setAttribute('data-catalog-theme', catalogTheme);
        }

        // Apply on initial load
        applyTheme();

        // Apply after Astro page transitions
        document.addEventListener('astro:after-swap', applyTheme);
        document.addEventListener('astro:page-load', applyTheme);
      })();
    </script>
    <SEO title={`EventCatalog | ${title}`} description={description} ogTitle={title} />
    <style is:global>
      .sidebar-transition {
        transition-property: width, transform;
        transition-duration: 300ms;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      }
      .tooltip {
        visibility: hidden;
        position: absolute;
      }
      .has-tooltip:hover .tooltip {
        visibility: visible;
        z-index: 100;
      }

      /* Hide anchor link by default */
      .anchor-link {
        display: inline-block;
        width: 1em;
        height: 1em;
        margin-left: 0.5rem;
        margin-top: 0.25rem;
        background-image: url('data:image/svg+xml,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2024%2024%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20fill%3D%22currentColor%22%20d%3D%22m12.11%2015.39-3.88%203.88a2.52%202.52%200%200%201-3.5%200%202.47%202.47%200%200%201%200-3.5l3.88-3.88a1%201%200%200%200-1.42-1.42l-3.88%203.89a4.48%204.48%200%200%200%206.33%206.33l3.89-3.88a1%201%200%201%200-1.42-1.42Zm8.58-12.08a4.49%204.49%200%200%200-6.33%200l-3.89%203.88a1%201%200%200%200%201.42%201.42l3.88-3.88a2.52%202.52%200%200%201%203.5%200%202.47%202.47%200%200%201%200%203.5l-3.88%203.88a1%201%200%201%200%201.42%201.42l3.88-3.89a4.49%204.49%200%200%200%200-6.33ZM8.83%2015.17a1%201%200%200%200%201.1.22%201%201%200%200%200%20.32-.22l4.92-4.92a1%201%200%200%200-1.42-1.42l-4.92%204.92a1%201%200%200%200%200%201.42Z%22/%3E%3C/svg%3E');
        background-repeat: no-repeat;
        background-position: center;
        background-size: 1em 1em;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        text-decoration: none;
        vertical-align: -2px;
      }

      /* Show icon on heading hover */
      h1:hover .anchor-link,
      h2:hover .anchor-link,
      h3:hover .anchor-link,
      h4:hover .anchor-link,
      h5:hover .anchor-link,
      h6:hover .anchor-link {
        opacity: 1;
      }

      /* Show on keyboard focus */
      .anchor-link:focus {
        opacity: 1;
        outline: none;
      }
    </style>
  </head>
  <body>
    {/* Load search data even when sidebar is hidden */}
    <SearchDataLoader />
    <main id="eventcatalog-application" class="relative">
      <div transition:persist="site-header">
        <Header />
      </div>
      <div class="flex">
        <aside class="flex" id="eventcatalog-vertical-nav">
          <div
            class="fixed flex flex-col items-center w-14 h-screen py-3 bg-[rgb(var(--ec-sidebar-bg))] bg-gradient-to-b from-[rgb(var(--ec-sidebar-bg))] to-[rgb(var(--ec-sidebar-bg-gradient))] border-r border-[rgb(var(--ec-sidebar-border))] z-20 shadow-md justify-between"
          >
            <nav class="flex flex-col h-[calc(100vh-70px)] justify-between">
              <div class="flex flex-col items-center flex-1 space-y-6">
                {
                  navigationItems.map((item) => {
                    return (
                      <a
                        id={item.id}
                        data-role="nav-item"
                        href={item.href}
                        aria-label={item.label}
                        class={`p-1.5 inline-block transition-colors duration-200 rounded-lg ${
                          item.current
                            ? 'text-[rgb(var(--ec-sidebar-active-text))] bg-[rgb(var(--ec-sidebar-active-bg))]'
                            : 'hover:bg-[rgb(var(--ec-sidebar-hover-bg))] hover:text-[rgb(var(--ec-sidebar-active-text))] text-[rgb(var(--ec-sidebar-text))]'
                        }`}
                      >
                        <div class="has-tooltip">
                          <span
                            class="tooltip rounded shadow-lg p-1 text-xs bg-gray-900 text-white ml-10 whitespace-nowrap"
                            aria-hidden="true"
                          >
                            {item.label}
                          </span>
                          <item.icon className="h-6 w-6" aria-hidden="true" />
                        </div>
                      </a>
                    );
                  })
                }

                <hr class="w-8 border-t border-[rgb(var(--ec-sidebar-border))]" />

                {
                  studioNavigationItem.length > 0 && (
                    <a
                      id={studioNavigationItem[0].id}
                      data-role="nav-item"
                      href={studioNavigationItem[0].href}
                      aria-label={studioNavigationItem[0].label}
                      class={`p-1.5 inline-block pt-1 pb-1 mt-0 mb-0 transition-colors duration-200 rounded-lg relative ${studioNavigationItem[0].current ? 'text-[rgb(var(--ec-sidebar-active-text))] bg-[rgb(var(--ec-sidebar-active-bg))]' : 'hover:bg-[rgb(var(--ec-sidebar-hover-bg))] hover:text-[rgb(var(--ec-sidebar-active-text))] text-[rgb(var(--ec-sidebar-text))]'}`}
                    >
                      <div class="has-tooltip">
                        <span
                          class="tooltip rounded shadow-lg p-1 text-xs bg-gray-900 text-white ml-10 whitespace-nowrap"
                          aria-hidden="true"
                        >
                          {studioNavigationItem[0].label}
                        </span>
                        <SquareDashedMousePointerIcon className="h-6 w-6" aria-hidden="true" />
                      </div>
                    </a>
                  )
                }

                {studioNavigationItem.length > 0 && <hr class="w-8 border-t border-[rgb(var(--ec-sidebar-border))]" />}

                {
                  premiumFeatures.map((item) => (
                    <a
                      id={item.id}
                      data-role="nav-item"
                      href={item.href}
                      aria-label={item.label}
                      class={`p-1.5 inline-block transition-colors duration-200 rounded-lg mb-8 relative ${
                        item.current
                          ? 'text-[rgb(var(--ec-sidebar-active-text))] bg-[rgb(var(--ec-sidebar-active-bg))]'
                          : 'hover:bg-[rgb(var(--ec-sidebar-hover-bg))] hover:text-[rgb(var(--ec-sidebar-active-text))] text-[rgb(var(--ec-sidebar-text))]'
                      }`}
                    >
                      <div class="has-tooltip">
                        <span
                          class="tooltip rounded shadow-lg p-1 text-xs bg-gray-900 text-white ml-10 flex items-center gap-1 whitespace-nowrap"
                          aria-hidden="true"
                        >
                          <Sparkles className="h-3 w-3" aria-hidden="true" /> {item.label}
                        </span>
                        <item.icon className="h-6 w-6" aria-hidden="true" />
                        <div
                          class="absolute -top-1 -right-1 bg-gradient-to-r from-amber-400 to-amber-500 rounded-full p-0.5 shadow-lg"
                          aria-hidden="true"
                        >
                          <Sparkles className="h-2 w-2 text-white" aria-hidden="true" />
                        </div>
                      </div>
                    </a>
                  ))
                }
              </div>

              {
                isEventCatalogUpgradeEnabled() && (
                  <div class="mb-4">
                    <a
                      id="/pro"
                      data-role="nav-item"
                      href={buildUrl('/plans')}
                      aria-label="Upgrade EventCatalog"
                      class={`p-1.5 inline-block transition-colors duration-200 rounded-lg ${currentPath.includes('/pro') ? 'text-[rgb(var(--ec-sidebar-active-text))] bg-[rgb(var(--ec-sidebar-active-bg))]' : 'bg-[rgb(var(--ec-sidebar-bg-gradient))] hover:bg-[rgb(var(--ec-sidebar-hover-bg))] hover:text-[rgb(var(--ec-sidebar-active-text))] text-[rgb(var(--ec-sidebar-text))]'}`}
                    >
                      <div class="has-tooltip">
                        <span
                          class="tooltip rounded shadow-lg p-1 text-xs bg-gray-900 text-white ml-10 whitespace-nowrap"
                          aria-hidden="true"
                        >
                          Upgrade EventCatalog
                        </span>
                        <Rocket className="h-6 w-6" aria-hidden="true" />
                      </div>
                    </a>
                  </div>
                )
              }
            </nav>
          </div>

          {
            showNestedSideBar && (
              <SideNav
                id="sidebar"
                class={`sidebar-transition h-content bg-[rgb(var(--ec-sidebar-bg))] border-r border-[rgb(var(--ec-sidebar-border))] w-[320px] ml-14`}
              />
            )
          }
        </aside>
        <main
          class={`sidebar-transition w-full max-h-content overflow-y-auto bg-[rgb(var(--ec-page-bg))] ${showNestedSideBar ? 'ml-0' : 'ml-14'}`}
          id="content"
        >
          <slot />
        </main>

        <!-- Create a overlay that tells people to purchase backstage plugin if they want to embed the page -->
        <div class="absolute inset-0 bg-black items-center justify-center z-50 hidden" id="embed-overlay">
          <div class="text-white text-center space-y-4">
            <div>
              <h1 class="text-2xl font-bold">EventCatalog Backstage Integration</h1>
              <p class="text-md text-red-500">Missing license key for backstage integration.</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Please configure the backstage plugin to embed this page into Backstage.</p>
              <a href="https://www.eventcatalog.dev/integrations/backstage" class="text-blue-500 text-xs"
                >Configure backstage plugin &rarr;</a
              >
            </div>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
<ClientRouter />
<script define:vars={{ navigationItems, currentNavigationItem, canPageBeEmbedded }}>
  // Listen for Astro transititions
  document.addEventListener('astro:page-load', () => {
    document.dispatchEvent(new CustomEvent('contentLoaded'));
  });

  // Listen for DOM loaded
  document.addEventListener('DOMContentLoaded', () => {
    document.dispatchEvent(new CustomEvent('contentLoaded'));
  });

  document.addEventListener('contentLoaded', () => {
    // Users can add ?embed=true to the URL to hide the navigation
    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    const embeded = params.embed === 'true' ? true : false;
    const content = document.getElementById('content');

    if (embeded && !canPageBeEmbedded) {
      const overlay = document.getElementById('embed-overlay');
      overlay.style.display = 'flex';
      return;
    }

    if (embeded) {
      const elementsToHide = [
        'eventcatalog-vertical-nav',
        'eventcatalog-header',
        'eventcatalog-header-spacer',
        'visualiser-footer',
        // /discover page elements
        'discover-collection-tabs',
        'discover-title',
      ];

      elementsToHide.forEach((id) => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'none';
      });

      content.classList.remove('ml-14');
      content.classList.remove('max-h-content');
      return;
    }

    const navItems = document.querySelectorAll('[data-role="nav-item"]');

    // Navigation items simply navigate to their href - no toggle logic
    navItems.forEach((item) => {
      item.addEventListener('click', (e) => {
        const id = item.getAttribute('id');
        const navItem = navigationItems.find((navItem) => navItem.id === id);

        if (navItem && navItem.href) {
          window.location.href = navItem.href;
        }
      });
    });
  });
</script>
