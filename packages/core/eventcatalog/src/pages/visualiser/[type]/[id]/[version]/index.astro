---
import NodeGraph from '@components/MDX/NodeGraph/NodeGraph.astro';
import VisualiserLayout from '@layouts/VisualiserLayout.astro';
import type { PageTypes } from '@types';
import { buildUrl } from '@utils/url-builder';
import { isDevMode } from '@utils/feature';
import { ClientRouter } from 'astro:transitions';

import { Page } from './_index.data';

export const prerender = Page.prerender;
export const getStaticPaths = Page.getStaticPaths;

// Get data
const props = await Page.getData(Astro);

const {
  data: { id },
  collection,
} = props;

const supportsPlaygroundExport = ['services', 'events', 'commands', 'queries', 'domains'].includes(collection as string);
const canOpenInPlayground = isDevMode() && supportsPlaygroundExport;
---

<VisualiserLayout title={`Visualiser | ${props.data.name} (${props.collection})`} description={props.data.summary}>
  <div class="m-4">
    <div
      class="h-[calc(100vh-130px)] w-full relative border border-[rgb(var(--ec-page-border))] rounded-md"
      id={`${id}-portal`}
      transition:animate="fade"
    >
    </div>
    <NodeGraph
      id={id}
      collection={collection}
      title={`${props.data.name} (v${props.data.version})`}
      mode="full"
      linkTo="visualiser"
      version={props.data.version}
      linksToVisualiser={false}
      zoomOnScroll={true}
      href={{
        label: `Open documentation for ${props.data.name} v${props.data.version}`,
        url: buildUrl(`/docs/${props.collection}/${props.data.id}/${props.data.version}`),
      }}
    />
  </div>
  <ClientRouter />
</VisualiserLayout>

<script define:vars={{ id, collection, version: props.data.version, canOpenInPlayground }}>
  const setupPage = () => {
    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    const embeded = params.embed === 'true' ? true : false;
    const viewport = document.getElementById(`${id}-portal`);

    if (embeded && viewport) {
      viewport.style.height = 'calc(100vh - 30px)';
    }

    if (!canOpenInPlayground) {
      return;
    }

    const openPlayground = async (buttonElement) => {
      try {
        buttonElement.setAttribute('disabled', 'true');
        buttonElement.textContent = 'Preparing DSL...';

        const res = await fetch(
          `/api/dev/playground-export?collection=${encodeURIComponent(collection)}&id=${encodeURIComponent(id)}&version=${encodeURIComponent(version)}&hydrate=true`
        );

        const payload = await res.json();

        if (!res.ok || !payload?.dsl) {
          throw new Error(payload?.error || 'Could not export DSL');
        }

        const encoded = btoa(unescape(encodeURIComponent(payload.dsl)));
        const playgroundUrl = `https://playground.eventcatalog.dev/?code=${encodeURIComponent(encoded)}`;
        window.open(playgroundUrl, '_blank', 'noopener,noreferrer');
      } catch (error) {
        alert(error instanceof Error ? error.message : 'Failed to open DSL Playground');
      } finally {
        buttonElement.removeAttribute('disabled');
        buttonElement.textContent = 'Open in Playground';
      }
    };

    const rewireStudioMenuItem = () => {
      const menuItems = document.querySelectorAll('[role="menuitem"]');

      menuItems.forEach((item) => {
        if (item.dataset.rewiredStudio !== 'true' && item.textContent?.includes('Open in EventCatalog Studio')) {
          item.dataset.rewiredStudio = 'true';
          const label = item.querySelector('span');
          if (label) {
            label.textContent = 'Open in Playground';
          }

          item.addEventListener(
            'click',
            (event) => {
              event.preventDefault();
              event.stopPropagation();
              openPlayground(item);
            },
            { capture: true }
          );
        }
      });
    };

    const observer = new MutationObserver(() => {
      rewireStudioMenuItem();
    });

    observer.observe(document.body, { childList: true, subtree: true });
    rewireStudioMenuItem();

    const rewireFooterStudioButton = (attempt = 0) => {
      const footerButton = document.querySelector('#visualiser-footer button');

      if (!footerButton) {
        if (attempt < 20) {
          setTimeout(() => rewireFooterStudioButton(attempt + 1), 150);
        }
        return;
      }

      if (footerButton.dataset.rewired === 'true') {
        return;
      }

      const replacement = footerButton.cloneNode(true);
      footerButton.replaceWith(replacement);

      replacement.dataset.rewired = 'true';
      replacement.querySelector('span')?.replaceChildren(document.createTextNode('Open in Playground'));
      replacement.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        openPlayground(replacement);
      });
    };

    rewireFooterStudioButton();
  };

  setupPage();
  document.addEventListener('astro:page-load', setupPage);
</script>
