---
import NodeGraph from '@components/MDX/NodeGraph/NodeGraph.astro';
import VisualiserLayout from '@layouts/VisualiserLayout.astro';
import type { PageTypes } from '@types';
import { buildUrl } from '@utils/url-builder';
import { isDevMode } from '@utils/feature';
import { ClientRouter } from 'astro:transitions';

import { Page } from './_index.data';

export const prerender = Page.prerender;
export const getStaticPaths = Page.getStaticPaths;

// Get data
const props = await Page.getData(Astro);

const {
  data: { id },
  collection,
} = props;

const supportsPlaygroundExport = ['services', 'events', 'commands', 'queries', 'domains'].includes(collection as string);
const canOpenInPlayground = isDevMode() && supportsPlaygroundExport;
---

<VisualiserLayout title={`Visualiser | ${props.data.name} (${props.collection})`} description={props.data.summary}>
  <div class="m-4">
    {
      canOpenInPlayground && (
        <div class="mb-3 flex justify-end">
          <button
            id="open-in-playground"
            type="button"
            class="inline-flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md border border-[rgb(var(--ec-page-border))] bg-[rgb(var(--ec-card-bg))] text-[rgb(var(--ec-page-text))] hover:bg-[rgb(var(--ec-content-hover))] transition-colors duration-150"
          >
            Open in DSL Playground (hydrated)
          </button>
        </div>
      )
    }
    <div
      class="h-[calc(100vh-130px)] w-full relative border border-[rgb(var(--ec-page-border))] rounded-md"
      id={`${id}-portal`}
      transition:animate="fade"
    >
    </div>
    <NodeGraph
      id={id}
      collection={collection}
      title={`${props.data.name} (v${props.data.version})`}
      mode="full"
      linkTo="visualiser"
      version={props.data.version}
      linksToVisualiser={false}
      zoomOnScroll={true}
      href={{
        label: `Open documentation for ${props.data.name} v${props.data.version}`,
        url: buildUrl(`/docs/${props.collection}/${props.data.id}/${props.data.version}`),
      }}
    />
  </div>
  <ClientRouter />
</VisualiserLayout>

<script define:vars={{ id, collection, version: props.data.version, canOpenInPlayground }}>
  const setupPage = () => {
    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    const embeded = params.embed === 'true' ? true : false;
    const viewport = document.getElementById(`${id}-portal`);

    if (embeded && viewport) {
      viewport.style.height = 'calc(100vh - 30px)';
    }

    if (!canOpenInPlayground) {
      return;
    }

    const button = document.getElementById('open-in-playground');
    if (!button || button.dataset.bound === 'true') {
      return;
    }

    button.dataset.bound = 'true';

    button.addEventListener('click', async () => {
      try {
        button.setAttribute('disabled', 'true');
        button.textContent = 'Preparing DSL...';

        const res = await fetch(
          `/api/dev/playground-export?collection=${encodeURIComponent(collection)}&id=${encodeURIComponent(id)}&version=${encodeURIComponent(version)}&hydrate=true`
        );

        const payload = await res.json();

        if (!res.ok || !payload?.dsl) {
          throw new Error(payload?.error || 'Could not export DSL');
        }

        const playgroundUrl = `https://playground.eventcatalog.dev/?dsl=${encodeURIComponent(payload.dsl)}`;
        window.open(playgroundUrl, '_blank', 'noopener,noreferrer');
      } catch (error) {
        alert(error instanceof Error ? error.message : 'Failed to open DSL Playground');
      } finally {
        button.removeAttribute('disabled');
        button.textContent = 'Open in DSL Playground (hydrated)';
      }
    });
  };

  setupPage();
  document.addEventListener('astro:page-load', setupPage);
</script>
