---
import VerticalSideBarLayout from '@layouts/VerticalSideBarLayout.astro';
import { ClientRouter } from 'astro:transitions';
---

<VerticalSideBarLayout title="IcePanel">
  <div class="h-[calc(100vh-80px)] bg-[rgb(var(--ec-page-bg))] p-3">
    <div class="flex items-center justify-between mb-4">
      <h1 id="diagramTitle" class="text-2xl font-bold text-[rgb(var(--ec-page-text))]">IcePanel Diagram</h1>
      <div class="flex items-center gap-3">
        <button
          id="backButton"
          class="hidden items-center gap-2 bg-[rgb(var(--ec-card-bg))] border border-[rgb(var(--ec-page-border))] text-[rgb(var(--ec-page-text))] hover:bg-[rgb(var(--ec-accent-subtle))] px-4 py-2 rounded-md transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L4.414 9H17a1 1 0 110 2H4.414l5.293 5.293a1 1 0 010 1.414z"
              clip-rule="evenodd"></path>
          </svg>
          <span>Back</span>
        </button>
      </div>
    </div>
    <div class="w-full bg-[rgb(var(--ec-card-bg))] h-[calc(100%-4rem)] rounded-2xl">
      <iframe class="w-full h-full rounded-2xl border-none"></iframe>
    </div>
  </div>
</VerticalSideBarLayout>

<ClientRouter />
<script>
  function configureIcePanel() {
    // Get url from query params and then embed into the iframe
    const pageUrl = new URL(window.location.href);
    const icePanelUrl = pageUrl.searchParams.get('url');
    const title = pageUrl.searchParams.get('title') || 'IcePanel Diagram';
    const backUrl = pageUrl.searchParams.get('back');

    // Configure back button if back URL is provided
    const backButton = document.querySelector('#backButton');
    if (backButton && backUrl) {
      backButton.classList.remove('hidden');
      backButton.classList.add('flex');
      backButton.addEventListener('click', () => {
        window.location.href = `${decodeURIComponent(backUrl)}#${title}-icepanel-title`;
      });
    }

    // Update the diagram title
    const diagramTitleElement = document.querySelector('#diagramTitle');
    if (diagramTitleElement) {
      diagramTitleElement.textContent = title;
    }

    const iframe = document.querySelector('iframe');
    if (iframe && icePanelUrl) {
      iframe.src = icePanelUrl;
      iframe.width = '100%';
      iframe.height = '100%';
    }
  }

  configureIcePanel();

  document.addEventListener('astro:page-load', configureIcePanel);
</script>
